# 0.1.masks_D

The **0.1.masks_D workflow** produces instance segmentations of the **nucleus** and **cellmask (cell area)** via fluorescence confocal microscopy images. Using the workflow steps, you can adjust the parameters described below to improve the quality of your segmentations. **0.1.masks_D** is an alternative *“masks”* workflow for iPSCs (induced pluripotent stem cells) with both nuclei and cell membrane markers. Images with one or multiple cells in the field of view are compatible with the workflow. If you are unsure that this workflow applies to your images, reference the imaging requirements listed below.

| **Imaging Requirements**               |   "1"    |    A     |    B     |    C     |    D     |
| :------------------------------------- | :------: | :------: | :------: | :------: | :------: |
| Nuclei Marker                          |   ✔     |   ✘      |   ✘      |   ✔     |   ✔      |
| Cell Membrane Marker                   |   ✘     |   ✘      |   ✘      |   ✔     |   ✔      |
| Cytoplasmic Organelles                 |   ✔     |   ✔      |   ✔      |   ✔     |   ✔      |
| Cells in FOV                           | Single or Multiple | Single   | Single or Multiple |Single or Multiple |Single or Multiple |

⚠️ Make sure that the first character of the microscopy image layer name is not numeric

## EXTRACTION


### **0.1.1 | Create composite image**

This step combines the intensities of the organelle channels from the input image to create a composite image of summed intensity values.

Parameters:

-	`weight_ch`: the scale factor applied to the channel of the corresponding index before summation. Larger weight_ch values lead to increased influence of the organelle’s intensities in the composite image
-	`Invert_PM`: whether to invert the intensities of the plasma membrane channel when creating the composite image
-	`PM_Channel`: the index of the plasma membrane channel (Please note that the first channel is indexed as 0)

❗ To prevent a specific organelle’s intensities from affecting the composite image, set the weight_ch parameter for that organelle’s index to 0.

### **0.1.2 | Segment nuclei (from label)**

In this step, a segmentation is generated for the nuclei. First, the intensities of the image are rescaled so that the minimum is 0 and the highest intensity is 1. A median and/or Gaussian filter is then applied to the nucleus channel to reduce noise. Next, a threshold is calculated and applied to the smoothed image using a logarithmic transformation and Li's minimum cross-entropy method. To conclude the nuclei segmentation, holes and objects are removed for final touches.

Parameters:

-	`nuc_chan`: the index of the nuclei channel (Please note that the first channel is indexed as 0)
-	`median_size`: the radius of the median filter; a large radius produces a more blurred image.
-	`gauss_sigma`:  the size of the Gaussian kernel; a larger sigma value produces a more blurred image.
-	`thresh_factor`: The ratio to be applied to the initial threshold value
-	`thresh_min`: The minimum value that can be used as a threshold
-	`thresh_max`: The maximum value that can be used as a threshold
-	`min_hole_width`: the minimum hole width to be filled in the segmentation post-thresholding
-	`max_hole_width`: the maximum hole width to be filled in the segmentation post-thresholding
-	`small_obj_width`: the minimum width of the objects to remain in the segmentation post-thresholding
-	`fill_filter_method`: determines if both the hole filling and size filtering methods are applied in 3D or on a 2D level (slice by slice)

❗ If the fill_filter_method drop-down menu is set to *“slice_by_slice”* the min_hole_width, max_hole_width, and small_obj_width values are squared, if set to *“3D”* the values are cubed.

## CORE


### **0.1.3 | Watershed for cellmask**

This step performs a watershed algorithm on the plasma membrane channel (with the PM intensities inverted) using the nuclei labels as the seeds. This helps the workflow designate the nuclei to their respective cells, creating the aggregate cellmask segmentation.

Parameters:

-	`PM_Channel`: the index of the plasma membrane channel (Please note that the first channel is indexed as 0)
-	`Method`: whether to perform the watershed on a “3D” level or on a 2D level “slice_by_slice”

❗ To prevent a specific organelle’s intensities from affecting the composite image, set the weight_ch parameter for that organelle’s index to 0.

## POSTPROCESSING


### **0.1.4 | Select cell from watershed**

This step selects the cellmask label with the maximum raw signal/intensities, creating the cellmask segmentation. The intensity values are derived from the composite image (output of step 0.1.1).

## POSTPOSTPROCESSING


### **0.1.5 | Hole Filling**

Holes are filled in the cellmask for some final cleaning before exporting.

Parameters:

-	`hole_min`: the width of the smallest hole to be filled
-	`hole_max`: the width of the largest hole to be filled
-	`fill_2d`: whether to fill holes in the image slice by slice (True) or in 3D (False)

## EXPORT


### **0.1.6 | Stack layers**

The final step stacks the nucleus and cellmask. The two masks are stored in a four-dimensional format and can be viewed individually in the output image layer using the sliders in the Napari UI. Toggling 3D view is recommended for inspection purposes.

### The masks_D segmentation workflow is now complete. The final layer can be saved using File > Save.

### Batch processing: If you wish to utilize these settings on more than one image, or revisit the settings later, use the *“Save Workflow”* button at the bottom of the workflow editor. Be sure the settings file ends in *“masks_D”*.
