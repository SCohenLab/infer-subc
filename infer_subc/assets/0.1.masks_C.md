# **0.1.masks_C**

The **0.1.masks_C workflow** produces instance segmentations of the **nucleus** and **cellmask (cell area)** from fluorescence confocal microscopy images. Using the workflow steps, you can adjust the parameters described below to improve the quality of your segmentations. **0.1.masks_C** is an alternative *“masks”* workflow for iNeurons (induced neurons) with both nuclei and cell membrane markers. Images with one or multiple cells in the field of view are compatible with the workflow. If you are unsure that this workflow applies to your images, reference the imaging requirements listed below.

| **Imaging Requirements**               |   "1"    |    A     |    B     |    C     |    D     |
| :------------------------------------- | :------: | :------: | :------: | :------: | :------: |
| Nuclei Marker                          |   ✔     |   ✘      |   ✘      |   ✔     |   ✔      |
| Cell Membrane Marker                   |   ✘     |   ✘      |   ✘      |   ✔     |   ✔      |
| Cytoplasmic Organelles                 |   ✔     |   ✔      |   ✔      |   ✔     |   ✔      |
| Cells in FOV                           | Single or Multiple | Single   | Single or Multiple |Single or Multiple |Single or Multiple |

⚠️ Make sure that the first character of the microscopy image layer name is not numeric

## EXTRACTION


### **0.1.1 | Create composite image - I**

This step combines the intensities of the organelle channels from the input image to create the first composite image of summed intensity values. By convention, the first composite is constructed to better capture the cell’s outer edges.

Parameters:

-	`weight_ch`: the scale factor applied to the channel of the corresponding index before summation. Larger weight_ch values lead to increased influence of the organelle’s intensities in the composite image
-	`Invert_PM`: whether to invert the intensities of the plasma membrane channel when creating the composite image
-	`PM_Channel`: the index of the plasma membrane channel (Please note that the first channel is indexed as 0)

❗ To prevent a specific organelle’s intensities from affecting the composite image, set the weight_ch parameter for that organelle’s index to 0.


### **0.1.2 | Create composite image - II**

This step combines the intensities of the organelle channels from the input image to create the second composite image of summed intensity values. The resulting composite image will be used to obtain the cell's nucleus. By convention, the second composite is constructed to better capture the intracellular area.

Parameters:

-	`weight_ch`: the scale factor applied to the channel of the corresponding index before summation. Larger weight_ch values lead to increased influence of the organelle’s intensities in the composite image
-	`Invert_PM`: whether to invert the intensities of the plasma membrane channel when creating the composite image
-	`PM_Channel`: the index of the plasma membrane channel (Please note that the first channel is indexed as 0)

❗ To prevent a specific organelle’s intensities from affecting the composite image, set the weight_ch parameter for that organelle’s index to 0.

❗ For comprehension, images that can be traced back to step 1 will have names ending in I. Following this pattern, images that can be traced back to step 2 will have names ending in II.

## PREPROCESSING


### **0.1.3 | Close gaps and apply filters – I**

If Method is *“Ball”* or *“Disk”*

This step performs a morphological closing algorithm on composite_I. Closing is an image processing operation where an image is dilated and subsequently eroded. This removes small holes, cracks, and pepper-like dark spots that may appear during image processing.

If Method is *“Scharr”*

This step combines two effects to emphasize the contrast between the object and the background. First, composite_I is transformed to fit a logarithmic scale. Separately, the Scharr edge detection algorithm is applied to composite_I. Finally, the two resulting images are merged to complete the step.

Parameters:

-	`Method`: Whether to use the closing algorithm (*“Ball”* and *“Disk”* denote the shape of the footprint that each voxel will affect during both the dilation and erosion) or the *“Scharr”* edge detection algorithm
-	`Size`: the radius of the footprint in pixel terms (if Method is *“Ball”* or *“Disk”*)


### **0.1.4 | Close gaps and apply filters – II**

If Method is *“Ball”* or *“Disk”*

This step performs a morphological closing algorithm on composite_II. Closing is an image processing operation where an image is dilated and subsequently eroded.  This removes small holes, cracks, and pepper-like dark spots that may appear during image processing.

If Method is *“Scharr”*

This step combines two effects to emphasize the contrast between the object and the background. First, composite_II is transformed to fit a logarithmic scale. Separately, the Scharr edge detection algorithm is applied to composite_II. Finally, the two resulting images are merged to complete the step.

Parameters:

-	`Method`: Whether to use the closing algorithm (*“Ball”* and *“Disk”* denote the shape of the footprint that each voxel will affect during both the dilation and erosion) or the *“Scharr”* edge detection algorithm
-	`Size`: the radius of the footprint in pixel terms (if Method is *“Ball”* or *“Disk”*)

## CORE


### **0.1.5 | Threshold object and restrict to PM - I**

This step applies the Allen Cell & Structure Segmenter “Masked Object Threshold” (MO) to composite_mask_I following closing or Scharr edge detection. First, a global threshold is performed on the composite_mask_I intensity values. Next, an Otsu threshold is applied locally for each connected component resulting from the global threshold, creating the mask_I segmentation.

If Bind_To_PM is *True*

Separately, an Otsu threshold is performed on a log-transformed version of the plasma membrane channel. Then, a logical AND is performed with the inverted plasma membrane segmentation and the mask_I segmentation.

Parameters:

-	`global_method`: The type of thresholding method to be performed globally (mask_I MO thresholding)
-	`cutoff_size`: The minimum object size to advance to the local thresholding step (mask_I MO thresholding)
-	`local_adjust`: The ratio applied to the local Otsu threshold (mask_I MO thresholding)
-	`Bind_To_PM`: Whether to restrict the mask_I segmentation to the plasma membrane
-	`PM_Channel`: the index of the plasma membrane channel (Please note that the first channel is indexed as 0)
-	`Thresh_Adj`: The ratio applied to the Otsu threshold of the plasma membrane

❗ If you do not wish to adjust the local thresholds set local_adjust and Thresh_Adj to 1.


### **0.1.6 | Threshold object and restrict to PM - II**

This step applies the Allen Cell & Structure Segmenter “Masked Object Threshold” (MO) to composite_mask_II following closing or Scharr edge detection. First, a global threshold is performed on the composite_mask_II intensity values. Next, an Otsu threshold is applied locally for each connected component resulting from the global threshold, creating the mask_II segmentation.

If Bind_To_PM is *True*

Separately, an Otsu threshold is performed on a log-transformed version of the plasma membrane channel. Then, a logical AND is performed with the inverted plasma membrane segmentation and the mask_II segmentation.

Parameters:

-	`global_method`: The type of thresholding method to be performed globally (mask_II MO thresholding)
-	`cutoff_size`: The minimum object size to advance to the local thresholding step (mask_II MO thresholding)
-	`local_adjust`: The ratio applied to the local Otsu threshold (mask_II MO thresholding)
-	`Bind_To_PM`: Whether to restrict the mask_II segmentation to the plasma membrane
-	`PM_Channel`: the index of the plasma membrane channel (Please note that the first channel is indexed as 0)
-	`Thresh_Adj`: The ratio applied to the Otsu threshold of the plasma membrane

❗ If you do not wish to adjust the local thresholds set local_adjust and Thresh_Adj to 1.

## POSTPROCESSING


### **0.1.7 | Find the nucleus corresponding to the cell**

In this step, a segmentation is generated to obtain the nucleus. First, the intensities of the nuclei channel are rescaled so that the minimum is 0 and the highest intensity is 1. A median and/or Gaussian filter is then applied to the nuclei channel to reduce noise. Next, a threshold is calculated and applied to the smoothed image using a logarithmic transformation and Li's minimum cross-entropy method. To complete the nuclei segmentation, holes and small objects are removed for cleaning. Finally, the nucleus label with the largest sum of overlap with the voxels from the Search_Img (either the mask_I or the mask_II segmentation) is selected. The result is the nucleus segmentation, which will be exported at the end of the workflow.

Parameters:

-	`Nuc_Channel`: the index of the nuclei channel (Please note that the first channel is indexed as 0)
-	`Median_Size`: the radius of the median filter; a large radius produces a more blurred image.
-	`Gauss_Sigma`:  the size of the Gaussian kernel; a larger sigma value produces a more blurred image.
-	`Thresh_Factor`: The ratio to be applied to the initial threshold value
-	`Thresh_Min`: The minimum value that can be used as a threshold
-	`Thresh_Max`: The maximum value that can be used as a threshold
-	`Min_Hole_Width`: the minimum hole width to be filled in the segmentation post-thresholding
-	`Max_Hole_Width`: the maximum hole width to be filled in the segmentation post-thresholding
-	`Small_Obj_Width`: the minimum width of the objects to remain in the segmentation post-thresholding
-	`Fill_Filter_Method`: determines if both the hole filling and size filtering methods are applied in 3D or on a 2D level (slice by slice)
-	`Search_Img`: the image used to select a single nucleus label based on its intensities (*“Img 5”* is the mask_I composite image and *“Img 6”* is the mask_II composite image)

❗ If the Fill_Filter_Method drop-down menu is set to *“slice_by_slice”* the Small_Obj_Width, Min_Hole_Width, and Max_Hole_Width values are squared, if set to *“3D”* the values are cubed.


### **0.1.8 | Combine nucleus and thresh and fill holes - I**

In this step, the nucleus mask is dilated and combined with the mask_I segmentation via a logical OR, creating the cellmask_I segmentation. To conclude the step, small holes and objects are removed for cleaning.

Parameters:

-	`Method`: the shape of the footprint (area/neighborhood that each voxel will affect during the dilation) 
-	`Size`: the radius of the footprint in pixel terms
-	`Min_Hole_Width`: the minimum hole width to be filled in the segmentation
-	`Max_Hole_Width`: the maximum hole width to be filled in the segmentation
-	`Small_Obj_Width`: the minimum width of the objects to remain in the segmentation

❗ The Small_Obj_Width, Min_Hole_Width, and Max_Hole_Width values will be squared


### **0.1.9 | Combine nucleus and thresh and fill holes - II**

In this step, the nucleus mask is dilated and combined with the mask_II segmentation via a logical OR, creating the cellmask_II segmentation. To conclude the step, small holes and objects are removed for cleaning.

Parameters:

-	`Method`: the shape of the footprint (area/neighborhood that each voxel will affect during the dilation)
-	`Size`: the radius of the footprint in pixel terms
-	`Min_Hole_Width`: the minimum hole width to be filled in the segmentation 
-	`Max_Hole_Width`: the maximum hole width to be filled in the segmentation 
-	`Small_Obj_Width`: the minimum width of the objects to remain in the segmentation

❗ The Small_Obj_Width, Min_Hole_Width, and Max_Hole_Width values will be squared

## POSTPOSTPROCESSING


### **0.1.10 | Watershed for cellmask**

In this step, a watershed algorithm is performed on both the mask_I and mask_II segmentations using the cellmask segmentations to mask each composite, respectively. The seed of the watershed algorithm in both cases is the nucleus segmentation. The results from each iteration are combined using a logical OR, creating the final cellmask segmentation. The cellmask undergoes closing (dilation -> erosion), then small holes are removed (on a 2D level) for cleaning purposes to conclude the step.

Parameters:

-	`Watershed_Method`: whether to perform the watershed on a *“3D”* level or on a 2D level *“slice_by_slice”*
-	`Min_Hole_Width`: the minimum hole width to be filled in the segmentation
-	`Max_Hole_Width`: the maximum hole width to be filled in the segmentation
-	`Method`: the shape of the footprint (area/neighborhood that each voxel will affect during both the dilation and erosion) 
-	`Size`: the radius of the footprint in pixel terms

## EXPORT


### **0.1.11 | stack masks**

The final step stacks the two masks in order of nucleus and cellmask. The two masks are stored in a four-dimensional format and can be viewed individually in the output image layer using the sliders in the Napari UI. Toggling 3D view is recommended for inspection purposes.

### The masks_C segmentation workflow is now complete. The final layer can be saved using File > Save.

### Batch processing: If you wish to utilize these settings on more than one image, or revisit the settings later, use the *“Save Workflow”* button at the bottom of the workflow editor. Be sure the settings file ends in *“masks_C”*.
